import{G as J,S as P,B as Y}from"./runtime-DWVsfJJv.js";let p=null,c=null,f=[],T="",_=null,l=new Set;const x=document.getElementById("admin-login"),L=document.getElementById("admin-table"),z=document.querySelector("[data-summary]"),I=document.querySelector("[data-refresh]"),O=document.querySelector("[data-export-current]"),R=document.querySelector("[data-export-all]"),q=document.querySelector("[data-signout]"),D=document.querySelector("[data-status]"),Q=document.getElementById("admin-grid"),B=document.querySelector("[data-visible-rows]"),M=document.querySelector("[data-visible-hours]"),A=document.querySelector("[data-area-filter-toggle]"),g=document.querySelector("[data-area-filter-menu]"),S=document.querySelector("[data-area-filter-options]"),h=document.querySelector("[data-area-filter-all]"),E=document.querySelector("[data-category-body]"),v=document.querySelector("[data-report-output]"),H=document.querySelector("[data-generate-report]");window.handleCredentialResponse=t=>{p=t.credential,sessionStorage.setItem("timebank_admin_token",p),u("Signing you in..."),F()};b();const X=sessionStorage.getItem("timebank_admin_token");X&&(p=X,F());I&&I.addEventListener("click",()=>F());O&&O.addEventListener("click",()=>oe());R&&R.addEventListener("click",()=>ae());q&&q.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),p=null,f=[],l=new Set,c&&(c.destroy(),c=null),L.classList.add("hidden"),x.classList.remove("hidden"),u("Signed out")});A&&g&&A.addEventListener("click",t=>{t.stopPropagation(),g.classList.toggle("hidden")});h&&h.addEventListener("change",()=>{if(!h.checked)return;l=new Set,(S?S.querySelectorAll('input[type="checkbox"]'):[]).forEach(e=>{e.checked=!1}),w()});H&&H.addEventListener("click",()=>{const t=$();v.value=ie(t)});document.addEventListener("click",t=>{!g||g.classList.contains("hidden")||g.contains(t.target)||A&&A.contains(t.target)||g.classList.add("hidden")});function b(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:J,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const t=document.querySelector("[data-gsi-admin]");t&&google.accounts.id.renderButton(t,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}b.attempts>30||(b.attempts+=1,setTimeout(b,250))}b.attempts=0;async function F(){if(!p){x.classList.remove("hidden"),L.classList.add("hidden");return}u("Loading data...");try{const i=await(await fetch(Y,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:P,credential:p}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),n=JSON.parse(i);if(!n.success)throw new Error(n.error||"Unknown error");T=n.drive&&n.drive.label?String(n.drive.label):"",_=n.generatedAt?new Date(n.generatedAt):new Date,f=ee(n.rows||[]),Z(f),ne(f),w(),C(),x.classList.add("hidden"),L.classList.remove("hidden"),u("")}catch(t){console.error(t),u(t.message||"Failed to load"),/Access denied/i.test(t.message||"")&&(x.classList.remove("hidden"),L.classList.add("hidden"))}}function Z(t){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!c){c=new Tabulator(Q,{data:t,layout:"fitDataStretch",height:"540px",index:"id",movableColumns:!0,pagination:!0,paginationSize:25,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",headerFilter:"input",width:260},{title:"Name",field:"name",headerFilter:"input",width:180},{title:"Batch",field:"batch",headerFilter:"input",width:90,hozAlign:"center"},{title:"Department",field:"department",headerFilter:"input",width:160},{title:"Mode",field:"modeLabel",headerFilter:"input",width:170},{title:"Hours bracket",field:"hoursCommitmentLabel",headerFilter:"input",width:140},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",width:120},{title:"Hours (min)",field:"hoursMin",sorter:"number",hozAlign:"right",bottomCalc:"sum",width:120},{title:"Hours (max)",field:"hoursMax",sorter:"number",hozAlign:"right",bottomCalc:"sum",width:120},{title:"Areas",field:"areasText",formatter:"textarea",width:360,headerFilter:"input"},{title:"Categories",field:"categoriesText",formatter:"textarea",width:220,headerFilter:"input"},{title:"Focus",field:"focusContext",formatter:"textarea",width:260,headerFilter:"input"},{title:"Timezone",field:"timezone",headerFilter:"input",width:120},{title:"Created",field:"createdAtDisplay",sorter:"datetime",width:170},{title:"Cohort",field:"cohort",headerFilter:"input",width:120}]}),c.on("dataFiltered",()=>C()),c.on("dataLoaded",()=>C());return}c.replaceData(t)}function ee(t){return t.map((e,i)=>{const n=te(e),o=y(e.categories),r=o.length?o:se(n),a=de(e.createdAt),s=e.hoursCommitmentLabel||e.hoursCommitmentKey||e.hoursCommitment||e["hours-commitment"]||"",d=m(e.hoursEstimate,ce(s)),G=m(e.hoursMin,d),U=m(e.hoursMax,d),V=e.modeLabel||e.modeKey||e.mode||"",W=e.focusContext||e["focus-context"]||"";return{id:String(e.donationId||"")||`row-${i}-${a}`,donationId:String(e.donationId||""),email:String(e.email||""),name:String(e.name||e.profile&&e.profile.name||""),batch:String(e.batch||e.profile&&e.profile.batch||""),department:String(e.department||e.profile&&e.profile.department||""),timezone:String(e.timezone||""),modeLabel:String(V),modeKey:String(e.modeKey||""),hoursCommitmentLabel:String(s),hoursCommitmentKey:String(e.hoursCommitmentKey||""),hoursEstimate:d,hoursMin:G,hoursMax:U,areas:n,areaIds:y(e.areaIds),areasText:n.join(`
`),categories:r,categoriesText:r.join(`
`),focusContext:String(W),startDate:String(e.startDate||""),endDate:String(e.endDate||""),createdAt:e.createdAt,createdAtTs:a,createdAtDisplay:N(a),cohort:String(e.cohort||"")}})}function y(t){return Array.isArray(t)?t.map(e=>String(e||"").trim()).filter(Boolean):[]}function te(t){const e=y(t.areas);if(e.length)return e;if(Array.isArray(t.area))return y(t.area);const i=String(t.area||"").trim();if(!i)return[];if(i[0]==="[")try{const n=JSON.parse(i);if(Array.isArray(n))return y(n)}catch{}return i.split(",").map(n=>n.trim()).filter(Boolean)}function ne(t){if(!S)return;const e={};t.forEach(r=>{(r.areas||[]).forEach(a=>{e[a]=(e[a]||0)+1})});const i=l,n=Object.keys(e).sort((r,a)=>r.localeCompare(a)),o=new Set;i.forEach(r=>{e[r]&&o.add(r)}),l=o,S.innerHTML="",n.forEach(r=>{const a=document.createElement("label");a.className="area-filter-option";const s=document.createElement("input");s.type="checkbox",s.value=r,s.checked=l.has(r),s.addEventListener("change",()=>{s.checked?l.add(r):l.delete(r),h&&(h.checked=l.size===0),w()});const d=document.createElement("span");d.textContent=`${r} (${e[r]})`,a.appendChild(s),a.appendChild(d),S.appendChild(a)}),h&&(h.checked=l.size===0)}function w(){c&&(c.setFilter(t=>l.size===0?!0:Array.isArray(t.areas)?t.areas.some(e=>l.has(e)):!1),C())}function C(){const t=$(),e=t.reduce((i,n)=>i+m(n.hoursEstimate,0),0);if(B&&(B.textContent=String(t.length)),M&&(M.textContent=k(e)),re(t),v&&(v.value=""),z){const i=_ instanceof Date?_:new Date;z.textContent=`${t.length} visible rows of ${f.length} total | Drive: ${T||"n/a"} | Updated: ${N(i.getTime())}`}}function $(){return c?c.getData("active")||[]:[]}function re(t){if(!E)return;const e={};t.forEach(n=>{(Array.isArray(n.categories)&&n.categories.length?n.categories:["Uncategorized"]).forEach(r=>{e[r]||(e[r]={hours:0,rows:0}),e[r].hours+=m(n.hoursEstimate,0),e[r].rows+=1})});const i=Object.keys(e).sort((n,o)=>e[o].hours-e[n].hours);if(E.innerHTML="",i.forEach(n=>{const o=document.createElement("tr"),r=k(e[n].hours);o.innerHTML=`<td>${ue(n)}</td><td>${r}</td><td>${e[n].rows}</td>`,E.appendChild(o)}),i.length===0){const n=document.createElement("tr");n.innerHTML='<td colspan="3">No rows in current view.</td>',E.appendChild(n)}}function ie(t){const e=new Date,i=t.reduce((a,s)=>a+m(s.hoursEstimate,0),0),n={};t.forEach(a=>{(Array.isArray(a.categories)&&a.categories.length?a.categories:["Uncategorized"]).forEach(d=>{n[d]||(n[d]={hours:0,rows:0}),n[d].hours+=m(a.hoursEstimate,0),n[d].rows+=1})});const o=[];o.push(`Weekly supply update (${le(e.getTime())})`),o.push(`Drive: ${T||"n/a"}`),o.push(`Visible donations: ${t.length}`),o.push(`Total estimated hours: ${k(i)}`),o.push(""),o.push("Breakdown by category (full row hours counted in each matching category):");const r=Object.keys(n).sort((a,s)=>n[s].hours-n[a].hours);return r.length?r.forEach(a=>{const s=n[a];o.push(`- ${a}: ${k(s.hours)} hours across ${s.rows} rows`)}):o.push("- No category data in current view."),o.push(`Generated at: ${N(e.getTime())}`),o.join(`
`)}function oe(){const t=$();if(!t.length){u("No rows in current view to export.");return}j(`timebank-current-view-${K(new Date)}.xlsx`,t)}function ae(){if(!f.length){u("No data to export.");return}j(`timebank-full-data-${K(new Date)}.xlsx`,f)}function j(t,e){if(!window.XLSX){u("XLSX export library failed to load.");return}const i=e.map(r=>({donation_id:r.donationId,email:r.email,name:r.name,batch:r.batch,department:r.department,mode:r.modeLabel,hours_bracket:r.hoursCommitmentLabel,hours_estimate:r.hoursEstimate,hours_min:r.hoursMin,hours_max:r.hoursMax,areas:r.areas.join(" | "),categories:r.categories.join(" | "),focus:r.focusContext,outreach_status:"",timezone:r.timezone,created_at:r.createdAtDisplay,cohort:r.cohort})),n=XLSX.utils.book_new(),o=XLSX.utils.json_to_sheet(i);XLSX.utils.book_append_sheet(n,o,"donations"),XLSX.writeFile(n,t),u(`Exported ${i.length} rows to ${t}`)}function se(t){const e={},i=[];return t.forEach(n=>{const o=String(n||"").trim();if(!o)return;const r=o.split(" > ")[0].trim();!r||e[r]||(e[r]=!0,i.push(r))}),i}function ce(t){const e=String(t||"").toLowerCase();if(e.indexOf("2-12")!==-1)return 7;if(e.indexOf("24")!==-1)return 24;if(e.indexOf("48")!==-1)return 48;const i=e.match(/(\d+)/);if(!i)return 0;const n=Number(i[1]);return Number.isFinite(n)?n:0}function m(t,e){const i=Number(t);return Number.isFinite(i)?i:Number(e)||0}function de(t){if(t==null||t==="")return 0;const e=new Date(t).getTime();return Number.isFinite(e)?e:0}function k(t){return m(t,0).toLocaleString(void 0,{maximumFractionDigits:1})}function le(t){if(!t)return"";const e=new Date(t);return Number.isFinite(e.getTime())?e.toISOString().slice(0,10):""}function N(t){if(!t)return"";const e=new Date(t);return Number.isFinite(e.getTime())?e.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function K(t){return t.toISOString().slice(0,10)}function ue(t){return String(t||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e]||e)}function u(t){D&&(D.textContent=t,D.classList.toggle("hidden",!t))}
