import{G as te,S as ne,B as re}from"./runtime-D2x3uCK1.js";let h=null,l=null,p=!1,L=!1,m=[],T="",F=null,s={mode:new Set,area:new Set,cohort:new Set};const b=document.getElementById("admin-login"),E=document.getElementById("admin-table"),O=document.querySelector("[data-summary]"),q=document.querySelector("[data-refresh]"),I=document.querySelector("[data-export-current]"),$=document.querySelector("[data-export-all]"),G=document.querySelector("[data-signout]"),x=document.querySelector("[data-status]"),ie=document.getElementById("admin-grid"),z=document.querySelector("[data-visible-rows]"),W=document.querySelector("[data-visible-hours]"),y=document.querySelector("[data-category-body]"),D=document.querySelector("[data-report-output]"),M=document.querySelector("[data-generate-report]"),oe=document.querySelector("[data-mode-filter-menu]"),j=document.querySelector("[data-mode-filter-all]"),K=document.querySelector("[data-mode-filter-options]"),ae=document.querySelector("[data-area-filter-menu]"),U=document.querySelector("[data-area-filter-all]"),V=document.querySelector("[data-area-filter-options]"),se=document.querySelector("[data-cohort-filter-menu]"),P=document.querySelector("[data-cohort-filter-all]"),J=document.querySelector("[data-cohort-filter-options]"),f=[{key:"mode",menu:oe,all:j,options:K,title:"Mode"},{key:"area",menu:ae,all:U,options:V,title:"Areas"},{key:"cohort",menu:se,all:P,options:J,title:"Cohort"}];window.handleCredentialResponse=e=>{h=e.credential,sessionStorage.setItem("timebank_admin_token",h),u("Signing you in..."),R()};g();le();const H=sessionStorage.getItem("timebank_admin_token");H&&(h=H,R());q&&q.addEventListener("click",()=>R());I&&I.addEventListener("click",()=>Le());$&&$.addEventListener("click",()=>Ae());G&&G.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),h=null,p=!1,L=!1,m=[],s={mode:new Set,area:new Set,cohort:new Set},l&&(l.destroy(),l=null),E.classList.add("hidden"),b.classList.remove("hidden"),u("Signed out")});M&&M.addEventListener("click",()=>{const e=B();D.value=Ee(e)});function le(){f.forEach(e=>{e.all&&e.all.addEventListener("change",()=>{if(!e.all.checked)return;s[e.key]=new Set,(e.options?e.options.querySelectorAll('input[type="checkbox"]'):[]).forEach(n=>{n.checked=!1}),e.key,A()})}),document.addEventListener("click",e=>{f.forEach(t=>{!t.menu||t.menu.classList.contains("hidden")||t.menu.contains(e.target)||t.menu.classList.add("hidden")})})}function _(e,t){const n=ce(e);if(!n||!n.menu||!t)return;const r=!n.menu.classList.contains("hidden");de(),r||(ue(n.menu,t),n.menu.classList.remove("hidden"))}function ce(e){for(let t=0;t<f.length;t+=1)if(f[t].key===e)return f[t];return null}function de(){f.forEach(e=>{e.menu&&e.menu.classList.add("hidden")})}function ue(e,t){if(!e||!t)return;e.classList.remove("hidden"),e.style.visibility="hidden",e.style.left="0px",e.style.top="0px";const n=t.getBoundingClientRect(),r=e.getBoundingClientRect();let o=n.left,i=n.bottom+8;o+r.width>window.innerWidth-8&&(o=window.innerWidth-r.width-8),o<8&&(o=8),i+r.height>window.innerHeight-8&&(i=n.top-r.height-8),i<8&&(i=8),e.style.left=`${o}px`,e.style.top=`${i}px`,e.style.visibility=""}function g(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:te,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const e=document.querySelector("[data-gsi-admin]");e&&google.accounts.id.renderButton(e,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}g.attempts>30||(g.attempts+=1,setTimeout(g,250))}g.attempts=0;async function R(){if(!h){b.classList.remove("hidden"),E.classList.add("hidden");return}u("Loading data...");try{const n=await(await fetch(re,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:ne,credential:h}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),r=JSON.parse(n);if(!r.success)throw new Error(r.error||"Unknown error");T=r.drive&&r.drive.label?String(r.drive.label):"",F=r.generatedAt?new Date(r.generatedAt):new Date,m=ge(r.rows||[]),me(m),ye(m),A(),S(),b.classList.add("hidden"),E.classList.remove("hidden"),u("")}catch(e){console.error(e),u(e.message||"Failed to load"),/Access denied/i.test(e.message||"")&&(b.classList.remove("hidden"),E.classList.add("hidden"))}}function me(e){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!l){p=!1,l=new Tabulator(ie,{data:e,layout:"fitColumns",height:"62vh",index:"id",movableColumns:!0,pagination:!0,paginationSize:30,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",minWidth:210,widthGrow:2},{title:"Name",field:"name",minWidth:140,widthGrow:1.4},{title:"Batch",field:"batch",minWidth:70,widthGrow:.7,hozAlign:"center"},{title:"Department",field:"department",minWidth:130,widthGrow:1.3},{title:"Mode",field:"modeLabel",minWidth:140,widthGrow:1,headerSort:!1,headerClick:(t,n)=>_("mode",n.getElement())},{title:"Hours bracket",field:"hoursCommitmentLabel",minWidth:120,widthGrow:1},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",minWidth:90,widthGrow:.8},{title:"Areas",field:"areas",formatter:fe,sorter:he,minWidth:300,widthGrow:3,headerSort:!1,headerClick:(t,n)=>_("area",n.getElement())},{title:"Focus",field:"focusContext",formatter:"textarea",minWidth:210,widthGrow:1.6},{title:"Timezone",field:"timezone",minWidth:90,widthGrow:.8},{title:"Created",field:"createdAtTs",sorter:"number",formatter:pe,minWidth:145,widthGrow:1},{title:"Cohort",field:"cohort",minWidth:90,widthGrow:.8,headerSort:!1,headerClick:(t,n)=>_("cohort",n.getElement())}]}),l.on("tableBuilt",()=>{p=!0,L?(L=!1,A()):S()}),l.on("dataFiltered",()=>S()),l.on("dataLoaded",()=>S());return}p=!0,l.replaceData(e)}function fe(e){const t=e.getValue(),n=Array.isArray(t)?t:[];return n.length?`<ul class="cell-list">${n.map(o=>{const i=ee(o);return`<li title="${i}">${i}</li>`}).join("")}</ul>`:""}function he(e,t){const n=X(e),r=X(t);return n.localeCompare(r)}function X(e){return Array.isArray(e)?e.map(t=>String(t||"")).join(" | ").toLowerCase():e==null?"":String(e).toLowerCase()}function pe(e){return k(Number(e.getValue()||0))}function ge(e){return e.map((t,n)=>{const r=Se(t),o=ke(t.createdAt),i=t.hoursCommitmentLabel||t.hoursCommitmentKey||t.hoursCommitment||t["hours-commitment"]||"",a=w(t.hoursEstimate,we(i)),c=t.modeLabel||t.modeKey||t.mode||"",d=t.focusContext||t["focus-context"]||"";return{id:String(t.donationId||"")||`row-${n}-${o}`,donationId:String(t.donationId||""),email:String(t.email||""),name:String(t.name||t.profile&&t.profile.name||""),batch:String(t.batch||t.profile&&t.profile.batch||""),department:String(t.department||t.profile&&t.profile.department||""),timezone:String(t.timezone||""),modeLabel:String(c),modeKey:String(t.modeKey||""),hoursCommitmentLabel:String(i),hoursCommitmentKey:String(t.hoursCommitmentKey||""),hoursEstimate:a,areas:r,focusContext:String(d),createdAt:t.createdAt,createdAtTs:o,createdAtDisplay:k(o),cohort:String(t.cohort||"")}})}function Se(e){if(Array.isArray(e.areas)&&e.areas.length)return e.areas.map(n=>String(n||"").trim()).filter(Boolean);if(Array.isArray(e.area)&&e.area.length)return e.area.map(n=>String(n||"").trim()).filter(Boolean);const t=String(e.area||"").trim();if(!t)return[];if(t[0]==="[")try{const n=JSON.parse(t);if(Array.isArray(n))return n.map(r=>String(r||"").trim()).filter(Boolean)}catch{}return t.split(",").map(n=>n.trim()).filter(Boolean)}function ye(e){C("mode",K,j,v(e,t=>[t.modeLabel]).filter(Boolean)),C("area",V,U,v(e,t=>t.areas||[]).filter(Boolean)),C("cohort",J,P,v(e,t=>[t.cohort]).filter(Boolean))}function v(e,t){const n={};return e.forEach(r=>{(t(r)||[]).forEach(i=>{const a=String(i||"").trim();a&&(n[a]=!0)})}),Object.keys(n).sort((r,o)=>r.localeCompare(o))}function C(e,t,n,r){if(!t)return;const o=s[e]||new Set,i=new Set;r.forEach(a=>{o.has(a)&&i.add(a)}),s[e]=i,t.innerHTML="",r.forEach(a=>{const c=document.createElement("label");c.className="area-filter-option";const d=document.createElement("input");d.type="checkbox",d.value=a,d.checked=s[e].has(a),d.addEventListener("change",()=>{d.checked?s[e].add(a):s[e].delete(a),n&&(n.checked=s[e].size===0),A()});const N=document.createElement("span");N.textContent=a,c.appendChild(d),c.appendChild(N),t.appendChild(c)}),n&&(n.checked=s[e].size===0)}function A(){if(l){if(!p){L=!0;return}l.setFilter(e=>!(s.mode.size>0&&!s.mode.has(String(e.modeLabel||""))||s.cohort.size>0&&!s.cohort.has(String(e.cohort||""))||s.area.size>0&&!(Array.isArray(e.areas)?e.areas:[]).some(r=>s.area.has(String(r||""))))),S()}}function S(){const e=B(),t=e.reduce((n,r)=>n+w(r.hoursEstimate,0),0);if(z&&(z.textContent=String(e.length)),W&&(W.textContent=Q(t)),be(e),D&&(D.value=""),O){const n=F instanceof Date?F:new Date;O.textContent=`${e.length} visible rows of ${m.length} total | Drive: ${T||"n/a"} | Updated: ${k(n.getTime())}`}}function B(){return l?l.getData("active")||[]:[]}function be(e){if(!y)return;const t={};e.forEach(r=>{(Array.isArray(r.areas)&&r.areas.length?r.areas:["Unspecified"]).forEach(i=>{t[i]||(t[i]={rows:0}),t[i].rows+=1})});const n=Object.keys(t).sort((r,o)=>t[o].rows-t[r].rows);if(y.innerHTML="",n.forEach(r=>{const o=document.createElement("tr");o.innerHTML=`<td>${ee(r)}</td><td>${t[r].rows}</td>`,y.appendChild(o)}),n.length===0){const r=document.createElement("tr");r.innerHTML='<td colspan="2">No rows in current view.</td>',y.appendChild(r)}}function Ee(e){const t=new Date,n=e.reduce((a,c)=>a+w(c.hoursEstimate,0),0),r={};e.forEach(a=>{(Array.isArray(a.areas)&&a.areas.length?a.areas:["Unspecified"]).forEach(d=>{r[d]=(r[d]||0)+1})});const o=[];o.push(`Weekly supply update (${xe(t.getTime())})`),o.push(`Drive: ${T||"n/a"}`),o.push(`Visible donations: ${e.length}`),o.push(`Total estimated hours: ${Q(n)}`),o.push(""),o.push("Breakdown by area (donation count):");const i=Object.keys(r).sort((a,c)=>r[c]-r[a]);return i.length?i.forEach(a=>{o.push(`- ${a}: ${r[a]} donations`)}):o.push("- No area data in current view."),o.push(""),o.push(`Generated at: ${k(t.getTime())}`),o.join(`
`)}function Le(){const e=B();if(!e.length){u("No rows in current view to export.");return}Y(`timebank-current-view-${Z(new Date)}.xlsx`,e)}function Ae(){if(!m.length){u("No data to export.");return}Y(`timebank-full-data-${Z(new Date)}.xlsx`,m)}function Y(e,t){if(!window.XLSX){u("XLSX export library failed to load.");return}const n=t.map(i=>({donation_id:i.donationId,email:i.email,name:i.name,batch:i.batch,department:i.department,mode:i.modeLabel,hours_bracket:i.hoursCommitmentLabel,hours_estimate:i.hoursEstimate,areas:i.areas.join(" | "),focus:i.focusContext,outreach_status:"",timezone:i.timezone,created_at:i.createdAtDisplay,cohort:i.cohort})),r=XLSX.utils.book_new(),o=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(r,o,"donations"),XLSX.writeFile(r,e),u(`Exported ${n.length} rows to ${e}`)}function we(e){const t=String(e||"").toLowerCase();if(t.indexOf("2-12")!==-1)return 7;if(t.indexOf("24")!==-1)return 24;if(t.indexOf("48")!==-1)return 48;const n=t.match(/(\d+)/);if(!n)return 0;const r=Number(n[1]);return Number.isFinite(r)?r:0}function w(e,t){const n=Number(e);return Number.isFinite(n)?n:Number(t)||0}function ke(e){if(e==null||e==="")return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}function Q(e){return w(e,0).toLocaleString(void 0,{maximumFractionDigits:1})}function xe(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function k(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function Z(e){return e.toISOString().slice(0,10)}function ee(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function u(e){x&&(x.textContent=e,x.classList.toggle("hidden",!e))}
