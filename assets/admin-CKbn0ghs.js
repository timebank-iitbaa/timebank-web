import{G as ne,S as re,B as ie}from"./runtime-D2x3uCK1.js";let h=null,l=null,p=!1,A=!1,m=[],B="",C=null,s={mode:new Set,area:new Set,cohort:new Set};const E=document.getElementById("admin-login"),L=document.getElementById("admin-table"),I=document.querySelector("[data-summary]"),G=document.querySelector("[data-refresh]"),z=document.querySelector("[data-export-current]"),W=document.querySelector("[data-export-all]"),H=document.querySelector("[data-signout]"),_=document.querySelector("[data-status]"),y=document.getElementById("admin-grid"),M=document.querySelector("[data-visible-rows]"),K=document.querySelector("[data-visible-hours]"),b=document.querySelector("[data-category-body]"),$=document.querySelector("[data-report-output]"),X=document.querySelector("[data-generate-report]"),oe=document.querySelector("[data-mode-filter-menu]"),U=document.querySelector("[data-mode-filter-all]"),V=document.querySelector("[data-mode-filter-options]"),ae=document.querySelector("[data-area-filter-menu]"),P=document.querySelector("[data-area-filter-all]"),J=document.querySelector("[data-area-filter-options]"),se=document.querySelector("[data-cohort-filter-menu]"),Y=document.querySelector("[data-cohort-filter-all]"),Q=document.querySelector("[data-cohort-filter-options]"),f=[{key:"mode",menu:oe,all:U,options:V,title:"Mode"},{key:"area",menu:ae,all:P,options:J,title:"Areas"},{key:"cohort",menu:se,all:Y,options:Q,title:"Cohort"}];window.handleCredentialResponse=e=>{h=e.credential,sessionStorage.setItem("timebank_admin_token",h),u("Signing you in..."),N()};g();le();const j=sessionStorage.getItem("timebank_admin_token");j&&(h=j,N());G&&G.addEventListener("click",()=>N());z&&z.addEventListener("click",()=>Ee());W&&W.addEventListener("click",()=>Le());H&&H.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),h=null,p=!1,A=!1,m=[],s={mode:new Set,area:new Set,cohort:new Set},l&&(l.destroy(),l=null),L.classList.add("hidden"),E.classList.remove("hidden"),u("Signed out")});X&&X.addEventListener("click",()=>{const e=q();$.value=be(e)});function le(){f.forEach(e=>{e.all&&e.all.addEventListener("change",()=>{if(!e.all.checked)return;s[e.key]=new Set,(e.options?e.options.querySelectorAll('input[type="checkbox"]'):[]).forEach(r=>{r.checked=!1}),R(e.key),x()})}),y&&y.addEventListener("click",e=>{const t=e.target.closest(".th-filter-trigger");if(!t)return;e.preventDefault(),e.stopPropagation();const r=t.getAttribute("data-filter-key");if(!r)return;const n=ce(r);if(!n||!n.menu)return;const i=!n.menu.classList.contains("hidden");de(),i||(ue(n.menu,t),n.menu.classList.remove("hidden"))}),document.addEventListener("click",e=>{f.forEach(t=>{!t.menu||t.menu.classList.contains("hidden")||t.menu.contains(e.target)||e.target.closest(".th-filter-trigger")||t.menu.classList.add("hidden")})})}function ce(e){for(let t=0;t<f.length;t+=1)if(f[t].key===e)return f[t];return null}function de(){f.forEach(e=>{e.menu&&e.menu.classList.add("hidden")})}function ue(e,t){if(!e||!t)return;e.classList.remove("hidden"),e.style.visibility="hidden",e.style.left="0px",e.style.top="0px";const r=t.getBoundingClientRect(),n=e.getBoundingClientRect();let i=r.left,o=r.bottom+8;i+n.width>window.innerWidth-8&&(i=window.innerWidth-n.width-8),i<8&&(i=8),o+n.height>window.innerHeight-8&&(o=r.top-n.height-8),o<8&&(o=8),e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.visibility=""}function g(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:ne,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const e=document.querySelector("[data-gsi-admin]");e&&google.accounts.id.renderButton(e,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}g.attempts>30||(g.attempts+=1,setTimeout(g,250))}g.attempts=0;async function N(){if(!h){E.classList.remove("hidden"),L.classList.add("hidden");return}u("Loading data...");try{const r=await(await fetch(ie,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:re,credential:h}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),n=JSON.parse(r);if(!n.success)throw new Error(n.error||"Unknown error");B=n.drive&&n.drive.label?String(n.drive.label):"",C=n.generatedAt?new Date(n.generatedAt):new Date,m=pe(n.rows||[]),me(m),Se(m),x(),S(),E.classList.add("hidden"),L.classList.remove("hidden"),u("")}catch(e){console.error(e),u(e.message||"Failed to load"),/Access denied/i.test(e.message||"")&&(E.classList.remove("hidden"),L.classList.add("hidden"))}}function me(e){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!l){p=!1,l=new Tabulator(y,{data:e,layout:"fitColumns",height:"62vh",index:"id",movableColumns:!0,pagination:!0,paginationSize:30,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",minWidth:210,widthGrow:2},{title:"Name",field:"name",minWidth:140,widthGrow:1.4},{title:"Batch",field:"batch",minWidth:70,widthGrow:.7,hozAlign:"center"},{title:"Department",field:"department",minWidth:130,widthGrow:1.3},{title:D("Mode","mode"),field:"modeLabel",minWidth:140,widthGrow:1},{title:"Hours bracket",field:"hoursCommitmentLabel",minWidth:120,widthGrow:1},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",minWidth:90,widthGrow:.8},{title:D("Areas","area"),field:"areas",formatter:fe,minWidth:300,widthGrow:3},{title:"Focus",field:"focusContext",formatter:"textarea",minWidth:210,widthGrow:1.6},{title:"Timezone",field:"timezone",minWidth:90,widthGrow:.8},{title:"Created",field:"createdAtTs",sorter:"number",formatter:he,minWidth:145,widthGrow:1},{title:D("Cohort","cohort"),field:"cohort",minWidth:90,widthGrow:.8}]}),l.on("tableBuilt",()=>{p=!0,A?(A=!1,x()):S()}),l.on("dataFiltered",()=>S()),l.on("dataLoaded",()=>S());return}p=!0,l.replaceData(e)}function fe(e){const t=e.getValue(),r=Array.isArray(t)?t:[];return r.length?`<ul class="cell-list">${r.map(i=>{const o=w(i);return`<li title="${o}">${o}</li>`}).join("")}</ul>`:""}function D(e,t){const r=w(e),n=w(t);return`<span class="th-filter-label">${r}</span><button class="th-filter-trigger" type="button" data-filter-key="${n}" aria-label="Filter ${r}">▾</button>`}function he(e){return v(Number(e.getValue()||0))}function pe(e){return e.map((t,r)=>{const n=ge(t),i=we(t.createdAt),o=t.hoursCommitmentLabel||t.hoursCommitmentKey||t.hoursCommitment||t["hours-commitment"]||"",a=k(t.hoursEstimate,Ae(o)),c=t.modeLabel||t.modeKey||t.mode||"",d=t.focusContext||t["focus-context"]||"";return{id:String(t.donationId||"")||`row-${r}-${i}`,donationId:String(t.donationId||""),email:String(t.email||""),name:String(t.name||t.profile&&t.profile.name||""),batch:String(t.batch||t.profile&&t.profile.batch||""),department:String(t.department||t.profile&&t.profile.department||""),timezone:String(t.timezone||""),modeLabel:String(c),modeKey:String(t.modeKey||""),hoursCommitmentLabel:String(o),hoursCommitmentKey:String(t.hoursCommitmentKey||""),hoursEstimate:a,areas:n,focusContext:String(d),createdAt:t.createdAt,createdAtTs:i,createdAtDisplay:v(i),cohort:String(t.cohort||"")}})}function ge(e){if(Array.isArray(e.areas)&&e.areas.length)return e.areas.map(r=>String(r||"").trim()).filter(Boolean);if(Array.isArray(e.area)&&e.area.length)return e.area.map(r=>String(r||"").trim()).filter(Boolean);const t=String(e.area||"").trim();if(!t)return[];if(t[0]==="[")try{const r=JSON.parse(t);if(Array.isArray(r))return r.map(n=>String(n||"").trim()).filter(Boolean)}catch{}return t.split(",").map(r=>r.trim()).filter(Boolean)}function Se(e){T("mode",V,U,F(e,t=>[t.modeLabel]).filter(Boolean)),T("area",J,P,F(e,t=>t.areas||[]).filter(Boolean)),T("cohort",Q,Y,F(e,t=>[t.cohort]).filter(Boolean))}function F(e,t){const r={};return e.forEach(n=>{(t(n)||[]).forEach(o=>{const a=String(o||"").trim();a&&(r[a]=!0)})}),Object.keys(r).sort((n,i)=>n.localeCompare(i))}function T(e,t,r,n){if(!t)return;const i=s[e]||new Set,o=new Set;n.forEach(a=>{i.has(a)&&o.add(a)}),s[e]=o,t.innerHTML="",n.forEach(a=>{const c=document.createElement("label");c.className="area-filter-option";const d=document.createElement("input");d.type="checkbox",d.value=a,d.checked=s[e].has(a),d.addEventListener("change",()=>{d.checked?s[e].add(a):s[e].delete(a),r&&(r.checked=s[e].size===0),R(e),x()});const O=document.createElement("span");O.textContent=a,c.appendChild(d),c.appendChild(O),t.appendChild(c)}),r&&(r.checked=s[e].size===0),R(e)}function R(e){const t=s[e]?s[e].size:0;(y?y.querySelectorAll(`.th-filter-trigger[data-filter-key="${e}"]`):[]).forEach(n=>{n.textContent=t>0?`▾${t}`:"▾",n.classList.toggle("is-active",t>0)})}function x(){if(l){if(!p){A=!0;return}l.setFilter(e=>!(s.mode.size>0&&!s.mode.has(String(e.modeLabel||""))||s.cohort.size>0&&!s.cohort.has(String(e.cohort||""))||s.area.size>0&&!(Array.isArray(e.areas)?e.areas:[]).some(n=>s.area.has(String(n||""))))),S()}}function S(){const e=q(),t=e.reduce((r,n)=>r+k(n.hoursEstimate,0),0);if(M&&(M.textContent=String(e.length)),K&&(K.textContent=ee(t)),ye(e),$&&($.value=""),I){const r=C instanceof Date?C:new Date;I.textContent=`${e.length} visible rows of ${m.length} total | Drive: ${B||"n/a"} | Updated: ${v(r.getTime())}`}}function q(){return l?l.getData("active")||[]:[]}function ye(e){if(!b)return;const t={};e.forEach(n=>{(Array.isArray(n.areas)&&n.areas.length?n.areas:["Unspecified"]).forEach(o=>{t[o]||(t[o]={rows:0}),t[o].rows+=1})});const r=Object.keys(t).sort((n,i)=>t[i].rows-t[n].rows);if(b.innerHTML="",r.forEach(n=>{const i=document.createElement("tr");i.innerHTML=`<td>${w(n)}</td><td>${t[n].rows}</td>`,b.appendChild(i)}),r.length===0){const n=document.createElement("tr");n.innerHTML='<td colspan="2">No rows in current view.</td>',b.appendChild(n)}}function be(e){const t=new Date,r=e.reduce((a,c)=>a+k(c.hoursEstimate,0),0),n={};e.forEach(a=>{(Array.isArray(a.areas)&&a.areas.length?a.areas:["Unspecified"]).forEach(d=>{n[d]=(n[d]||0)+1})});const i=[];i.push(`Weekly supply update (${xe(t.getTime())})`),i.push(`Drive: ${B||"n/a"}`),i.push(`Visible donations: ${e.length}`),i.push(`Total estimated hours: ${ee(r)}`),i.push(""),i.push("Breakdown by area (donation count):");const o=Object.keys(n).sort((a,c)=>n[c]-n[a]);return o.length?o.forEach(a=>{i.push(`- ${a}: ${n[a]} donations`)}):i.push("- No area data in current view."),i.push(""),i.push(`Generated at: ${v(t.getTime())}`),i.join(`
`)}function Ee(){const e=q();if(!e.length){u("No rows in current view to export.");return}Z(`timebank-current-view-${te(new Date)}.xlsx`,e)}function Le(){if(!m.length){u("No data to export.");return}Z(`timebank-full-data-${te(new Date)}.xlsx`,m)}function Z(e,t){if(!window.XLSX){u("XLSX export library failed to load.");return}const r=t.map(o=>({donation_id:o.donationId,email:o.email,name:o.name,batch:o.batch,department:o.department,mode:o.modeLabel,hours_bracket:o.hoursCommitmentLabel,hours_estimate:o.hoursEstimate,areas:o.areas.join(" | "),focus:o.focusContext,outreach_status:"",timezone:o.timezone,created_at:o.createdAtDisplay,cohort:o.cohort})),n=XLSX.utils.book_new(),i=XLSX.utils.json_to_sheet(r);XLSX.utils.book_append_sheet(n,i,"donations"),XLSX.writeFile(n,e),u(`Exported ${r.length} rows to ${e}`)}function Ae(e){const t=String(e||"").toLowerCase();if(t.indexOf("2-12")!==-1)return 7;if(t.indexOf("24")!==-1)return 24;if(t.indexOf("48")!==-1)return 48;const r=t.match(/(\d+)/);if(!r)return 0;const n=Number(r[1]);return Number.isFinite(n)?n:0}function k(e,t){const r=Number(e);return Number.isFinite(r)?r:Number(t)||0}function we(e){if(e==null||e==="")return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}function ee(e){return k(e,0).toLocaleString(void 0,{maximumFractionDigits:1})}function xe(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function v(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function te(e){return e.toISOString().slice(0,10)}function w(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function u(e){_&&(_.textContent=e,_.classList.toggle("hidden",!e))}
