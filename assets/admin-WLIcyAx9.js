import{G as ee,S as te,B as ne}from"./runtime-D2x3uCK1.js";let h=null,l=null,m=[],C="",_=null,s={mode:new Set,area:new Set,cohort:new Set};const y=document.getElementById("admin-login"),b=document.getElementById("admin-table"),R=document.querySelector("[data-summary]"),N=document.querySelector("[data-refresh]"),I=document.querySelector("[data-export-current]"),z=document.querySelector("[data-export-all]"),G=document.querySelector("[data-signout]"),w=document.querySelector("[data-status]"),g=document.getElementById("admin-grid"),W=document.querySelector("[data-visible-rows]"),H=document.querySelector("[data-visible-hours]"),S=document.querySelector("[data-category-body]"),D=document.querySelector("[data-report-output]"),M=document.querySelector("[data-generate-report]"),re=document.querySelector("[data-mode-filter-menu]"),X=document.querySelector("[data-mode-filter-all]"),j=document.querySelector("[data-mode-filter-options]"),ie=document.querySelector("[data-area-filter-menu]"),U=document.querySelector("[data-area-filter-all]"),V=document.querySelector("[data-area-filter-options]"),oe=document.querySelector("[data-cohort-filter-menu]"),J=document.querySelector("[data-cohort-filter-all]"),P=document.querySelector("[data-cohort-filter-options]"),f=[{key:"mode",menu:re,all:X,options:j,title:"Mode"},{key:"area",menu:ie,all:U,options:V,title:"Areas"},{key:"cohort",menu:oe,all:J,options:P,title:"Cohort"}];window.handleCredentialResponse=e=>{h=e.credential,sessionStorage.setItem("timebank_admin_token",h),u("Signing you in..."),T()};p();ae();const K=sessionStorage.getItem("timebank_admin_token");K&&(h=K,T());N&&N.addEventListener("click",()=>T());I&&I.addEventListener("click",()=>Se());z&&z.addEventListener("click",()=>ye());G&&G.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),h=null,m=[],s={mode:new Set,area:new Set,cohort:new Set},l&&(l.destroy(),l=null),b.classList.add("hidden"),y.classList.remove("hidden"),u("Signed out")});M&&M.addEventListener("click",()=>{const e=q();D.value=ge(e)});function ae(){f.forEach(e=>{e.all&&e.all.addEventListener("change",()=>{if(!e.all.checked)return;s[e.key]=new Set,(e.options?e.options.querySelectorAll('input[type="checkbox"]'):[]).forEach(r=>{r.checked=!1}),F(e.key),$()})}),g&&g.addEventListener("click",e=>{const t=e.target.closest(".th-filter-trigger");if(!t)return;e.preventDefault(),e.stopPropagation();const r=t.getAttribute("data-filter-key");if(!r)return;const n=se(r);if(!n||!n.menu)return;const i=!n.menu.classList.contains("hidden");le(),i||(ce(n.menu,t),n.menu.classList.remove("hidden"))}),document.addEventListener("click",e=>{f.forEach(t=>{!t.menu||t.menu.classList.contains("hidden")||t.menu.contains(e.target)||e.target.closest(".th-filter-trigger")||t.menu.classList.add("hidden")})})}function se(e){for(let t=0;t<f.length;t+=1)if(f[t].key===e)return f[t];return null}function le(){f.forEach(e=>{e.menu&&e.menu.classList.add("hidden")})}function ce(e,t){if(!e||!t)return;e.classList.remove("hidden"),e.style.visibility="hidden",e.style.left="0px",e.style.top="0px";const r=t.getBoundingClientRect(),n=e.getBoundingClientRect();let i=r.left,o=r.bottom+8;i+n.width>window.innerWidth-8&&(i=window.innerWidth-n.width-8),i<8&&(i=8),o+n.height>window.innerHeight-8&&(o=r.top-n.height-8),o<8&&(o=8),e.style.left=`${i}px`,e.style.top=`${o}px`,e.style.visibility=""}function p(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:ee,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const e=document.querySelector("[data-gsi-admin]");e&&google.accounts.id.renderButton(e,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}p.attempts>30||(p.attempts+=1,setTimeout(p,250))}p.attempts=0;async function T(){if(!h){y.classList.remove("hidden"),b.classList.add("hidden");return}u("Loading data...");try{const r=await(await fetch(ne,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:te,credential:h}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),n=JSON.parse(r);if(!n.success)throw new Error(n.error||"Unknown error");C=n.drive&&n.drive.label?String(n.drive.label):"",_=n.generatedAt?new Date(n.generatedAt):new Date,m=me(n.rows||[]),de(m),he(m),$(),E(),y.classList.add("hidden"),b.classList.remove("hidden"),u("")}catch(e){console.error(e),u(e.message||"Failed to load"),/Access denied/i.test(e.message||"")&&(y.classList.remove("hidden"),b.classList.add("hidden"))}}function de(e){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!l){l=new Tabulator(g,{data:e,layout:"fitColumns",height:"62vh",index:"id",movableColumns:!0,pagination:!0,paginationSize:30,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",minWidth:210,widthGrow:2},{title:"Name",field:"name",minWidth:140,widthGrow:1.4},{title:"Batch",field:"batch",minWidth:70,widthGrow:.7,hozAlign:"center"},{title:"Department",field:"department",minWidth:130,widthGrow:1.3},{title:x("Mode","mode"),field:"modeLabel",minWidth:140,widthGrow:1},{title:"Hours bracket",field:"hoursCommitmentLabel",minWidth:120,widthGrow:1},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",minWidth:90,widthGrow:.8},{title:x("Areas","area"),field:"areas",formatter:ue,minWidth:300,widthGrow:3},{title:"Focus",field:"focusContext",formatter:"textarea",minWidth:210,widthGrow:1.6},{title:"Timezone",field:"timezone",minWidth:90,widthGrow:.8},{title:"Created",field:"createdAtDisplay",sorter:"datetime",minWidth:145,widthGrow:1},{title:x("Cohort","cohort"),field:"cohort",minWidth:90,widthGrow:.8}]}),l.on("dataFiltered",()=>E()),l.on("dataLoaded",()=>E());return}l.replaceData(e)}function ue(e){const t=e.getValue(),r=Array.isArray(t)?t:[];return r.length?`<ul class="cell-list">${r.map(i=>{const o=L(i);return`<li title="${o}">${o}</li>`}).join("")}</ul>`:""}function x(e,t){const r=L(e),n=L(t);return`<span class="th-filter-label">${r}</span><button class="th-filter-trigger" type="button" data-filter-key="${n}" aria-label="Filter ${r}">▾</button>`}function me(e){return e.map((t,r)=>{const n=fe(t),i=Ee(t.createdAt),o=t.hoursCommitmentLabel||t.hoursCommitmentKey||t.hoursCommitment||t["hours-commitment"]||"",a=A(t.hoursEstimate,be(o)),c=t.modeLabel||t.modeKey||t.mode||"",d=t.focusContext||t["focus-context"]||"";return{id:String(t.donationId||"")||`row-${r}-${i}`,donationId:String(t.donationId||""),email:String(t.email||""),name:String(t.name||t.profile&&t.profile.name||""),batch:String(t.batch||t.profile&&t.profile.batch||""),department:String(t.department||t.profile&&t.profile.department||""),timezone:String(t.timezone||""),modeLabel:String(c),modeKey:String(t.modeKey||""),hoursCommitmentLabel:String(o),hoursCommitmentKey:String(t.hoursCommitmentKey||""),hoursEstimate:a,areas:n,focusContext:String(d),createdAt:t.createdAt,createdAtTs:i,createdAtDisplay:B(i),cohort:String(t.cohort||"")}})}function fe(e){if(Array.isArray(e.areas)&&e.areas.length)return e.areas.map(r=>String(r||"").trim()).filter(Boolean);if(Array.isArray(e.area)&&e.area.length)return e.area.map(r=>String(r||"").trim()).filter(Boolean);const t=String(e.area||"").trim();if(!t)return[];if(t[0]==="[")try{const r=JSON.parse(t);if(Array.isArray(r))return r.map(n=>String(n||"").trim()).filter(Boolean)}catch{}return t.split(",").map(r=>r.trim()).filter(Boolean)}function he(e){v("mode",j,X,k(e,t=>[t.modeLabel]).filter(Boolean)),v("area",V,U,k(e,t=>t.areas||[]).filter(Boolean)),v("cohort",P,J,k(e,t=>[t.cohort]).filter(Boolean))}function k(e,t){const r={};return e.forEach(n=>{(t(n)||[]).forEach(o=>{const a=String(o||"").trim();a&&(r[a]=!0)})}),Object.keys(r).sort((n,i)=>n.localeCompare(i))}function v(e,t,r,n){if(!t)return;const i=s[e]||new Set,o=new Set;n.forEach(a=>{i.has(a)&&o.add(a)}),s[e]=o,t.innerHTML="",n.forEach(a=>{const c=document.createElement("label");c.className="area-filter-option";const d=document.createElement("input");d.type="checkbox",d.value=a,d.checked=s[e].has(a),d.addEventListener("change",()=>{d.checked?s[e].add(a):s[e].delete(a),r&&(r.checked=s[e].size===0),F(e),$()});const O=document.createElement("span");O.textContent=a,c.appendChild(d),c.appendChild(O),t.appendChild(c)}),r&&(r.checked=s[e].size===0),F(e)}function F(e){const t=s[e]?s[e].size:0;(g?g.querySelectorAll(`.th-filter-trigger[data-filter-key="${e}"]`):[]).forEach(n=>{n.textContent=t>0?`▾${t}`:"▾",n.classList.toggle("is-active",t>0)})}function $(){l&&(l.setFilter(e=>!(s.mode.size>0&&!s.mode.has(String(e.modeLabel||""))||s.cohort.size>0&&!s.cohort.has(String(e.cohort||""))||s.area.size>0&&!(Array.isArray(e.areas)?e.areas:[]).some(n=>s.area.has(String(n||""))))),E())}function E(){const e=q(),t=e.reduce((r,n)=>r+A(n.hoursEstimate,0),0);if(W&&(W.textContent=String(e.length)),H&&(H.textContent=Q(t)),pe(e),D&&(D.value=""),R){const r=_ instanceof Date?_:new Date;R.textContent=`${e.length} visible rows of ${m.length} total | Drive: ${C||"n/a"} | Updated: ${B(r.getTime())}`}}function q(){return l?l.getData("active")||[]:[]}function pe(e){if(!S)return;const t={};e.forEach(n=>{(Array.isArray(n.areas)&&n.areas.length?n.areas:["Unspecified"]).forEach(o=>{t[o]||(t[o]={rows:0}),t[o].rows+=1})});const r=Object.keys(t).sort((n,i)=>t[i].rows-t[n].rows);if(S.innerHTML="",r.forEach(n=>{const i=document.createElement("tr");i.innerHTML=`<td>${L(n)}</td><td>${t[n].rows}</td>`,S.appendChild(i)}),r.length===0){const n=document.createElement("tr");n.innerHTML='<td colspan="2">No rows in current view.</td>',S.appendChild(n)}}function ge(e){const t=new Date,r=e.reduce((a,c)=>a+A(c.hoursEstimate,0),0),n={};e.forEach(a=>{(Array.isArray(a.areas)&&a.areas.length?a.areas:["Unspecified"]).forEach(d=>{n[d]=(n[d]||0)+1})});const i=[];i.push(`Weekly supply update (${Le(t.getTime())})`),i.push(`Drive: ${C||"n/a"}`),i.push(`Visible donations: ${e.length}`),i.push(`Total estimated hours: ${Q(r)}`),i.push(""),i.push("Breakdown by area (donation count):");const o=Object.keys(n).sort((a,c)=>n[c]-n[a]);return o.length?o.forEach(a=>{i.push(`- ${a}: ${n[a]} donations`)}):i.push("- No area data in current view."),i.push(""),i.push(`Generated at: ${B(t.getTime())}`),i.join(`
`)}function Se(){const e=q();if(!e.length){u("No rows in current view to export.");return}Y(`timebank-current-view-${Z(new Date)}.xlsx`,e)}function ye(){if(!m.length){u("No data to export.");return}Y(`timebank-full-data-${Z(new Date)}.xlsx`,m)}function Y(e,t){if(!window.XLSX){u("XLSX export library failed to load.");return}const r=t.map(o=>({donation_id:o.donationId,email:o.email,name:o.name,batch:o.batch,department:o.department,mode:o.modeLabel,hours_bracket:o.hoursCommitmentLabel,hours_estimate:o.hoursEstimate,areas:o.areas.join(" | "),focus:o.focusContext,outreach_status:"",timezone:o.timezone,created_at:o.createdAtDisplay,cohort:o.cohort})),n=XLSX.utils.book_new(),i=XLSX.utils.json_to_sheet(r);XLSX.utils.book_append_sheet(n,i,"donations"),XLSX.writeFile(n,e),u(`Exported ${r.length} rows to ${e}`)}function be(e){const t=String(e||"").toLowerCase();if(t.indexOf("2-12")!==-1)return 7;if(t.indexOf("24")!==-1)return 24;if(t.indexOf("48")!==-1)return 48;const r=t.match(/(\d+)/);if(!r)return 0;const n=Number(r[1]);return Number.isFinite(n)?n:0}function A(e,t){const r=Number(e);return Number.isFinite(r)?r:Number(t)||0}function Ee(e){if(e==null||e==="")return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}function Q(e){return A(e,0).toLocaleString(void 0,{maximumFractionDigits:1})}function Le(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function B(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function Z(e){return e.toISOString().slice(0,10)}function L(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function u(e){w&&(w.textContent=e,w.classList.toggle("hidden",!e))}
