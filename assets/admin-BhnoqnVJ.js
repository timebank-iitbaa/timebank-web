import{G as oe,S as ae,B as se}from"./runtime-fvWO6ccx.js";let h=null,l=null,p=!1,L=!1,m=[],N="",$=null,s={mode:new Set,area:new Set,cohort:new Set};const b=document.getElementById("admin-login"),E=document.getElementById("admin-table"),G=document.querySelector("[data-summary]"),z=document.querySelector("[data-refresh]"),W=document.querySelector("[data-export-current]"),H=document.querySelector("[data-export-all]"),M=document.querySelector("[data-signout]"),F=document.querySelector("[data-status]"),B=document.getElementById("admin-grid"),X=document.querySelector("[data-visible-rows]"),K=document.querySelector("[data-visible-hours]"),y=document.querySelector("[data-category-body]"),R=document.querySelector("[data-report-output]"),j=document.querySelector("[data-generate-report]"),le=document.querySelector("[data-mode-filter-menu]"),J=document.querySelector("[data-mode-filter-all]"),Y=document.querySelector("[data-mode-filter-options]"),ce=document.querySelector("[data-area-filter-menu]"),Q=document.querySelector("[data-area-filter-all]"),Z=document.querySelector("[data-area-filter-options]"),de=document.querySelector("[data-cohort-filter-menu]"),ee=document.querySelector("[data-cohort-filter-all]"),te=document.querySelector("[data-cohort-filter-options]"),f=[{key:"mode",menu:le,all:J,options:Y,title:"Mode"},{key:"area",menu:ce,all:Q,options:Z,title:"Areas"},{key:"cohort",menu:de,all:ee,options:te,title:"Cohort"}];window.handleCredentialResponse=e=>{h=e.credential,sessionStorage.setItem("timebank_admin_token",h),u("Signing you in..."),q()};g();ue();const U=sessionStorage.getItem("timebank_admin_token");U&&(h=U,q());z&&z.addEventListener("click",()=>q());W&&W.addEventListener("click",()=>xe());H&&H.addEventListener("click",()=>_e());M&&M.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),h=null,p=!1,L=!1,m=[],s={mode:new Set,area:new Set,cohort:new Set},l&&(l.destroy(),l=null),E.classList.add("hidden"),b.classList.remove("hidden"),u("Signed out")});j&&j.addEventListener("click",()=>{const e=O();R.value=we(e)});function ue(){f.forEach(e=>{e.all&&e.all.addEventListener("change",()=>{if(!e.all.checked)return;s[e.key]=new Set,(e.options?e.options.querySelectorAll('input[type="checkbox"]'):[]).forEach(n=>{n.checked=!1}),A(e.key),x()})}),document.addEventListener("click",e=>{f.forEach(t=>{!t.menu||t.menu.classList.contains("hidden")||t.menu.contains(e.target)||t.menu.classList.add("hidden")})})}function C(e,t){const n=me(e);if(!n||!n.menu||!t)return;const r=!n.menu.classList.contains("hidden");fe(),r||(he(n.menu,t),n.menu.classList.remove("hidden"))}function me(e){for(let t=0;t<f.length;t+=1)if(f[t].key===e)return f[t];return null}function fe(){f.forEach(e=>{e.menu&&e.menu.classList.add("hidden")})}function he(e,t){if(!e||!t)return;e.classList.remove("hidden"),e.style.visibility="hidden",e.style.left="0px",e.style.top="0px";const n=t.getBoundingClientRect(),r=e.getBoundingClientRect();let o=n.left,i=n.bottom+8;o+r.width>window.innerWidth-8&&(o=window.innerWidth-r.width-8),o<8&&(o=8),i+r.height>window.innerHeight-8&&(i=n.top-r.height-8),i<8&&(i=8),e.style.left=`${o}px`,e.style.top=`${i}px`,e.style.visibility=""}function g(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:oe,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const e=document.querySelector("[data-gsi-admin]");e&&google.accounts.id.renderButton(e,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}g.attempts>30||(g.attempts+=1,setTimeout(g,250))}g.attempts=0;async function q(){if(!h){b.classList.remove("hidden"),E.classList.add("hidden");return}u("Loading data...");try{const n=await(await fetch(se,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:ae,credential:h}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),r=JSON.parse(n);if(!r.success)throw new Error(r.error||"Unknown error");N=r.drive&&r.drive.label?String(r.drive.label):"",$=r.generatedAt?new Date(r.generatedAt):new Date,m=be(r.rows||[]),pe(m),Le(m),x(),S(),b.classList.add("hidden"),E.classList.remove("hidden"),u("")}catch(e){console.error(e),u(e.message||"Failed to load"),/Access denied/i.test(e.message||"")&&(b.classList.remove("hidden"),E.classList.add("hidden"))}}function pe(e){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!l){p=!1,l=new Tabulator(B,{data:e,layout:"fitColumns",height:"62vh",index:"id",movableColumns:!0,pagination:!0,paginationSize:30,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",minWidth:210,widthGrow:2},{title:"Name",field:"name",minWidth:140,widthGrow:1.4},{title:"Batch",field:"batch",minWidth:70,widthGrow:.7,hozAlign:"center"},{title:"Department",field:"department",minWidth:130,widthGrow:1.3},{title:v("Mode","mode"),field:"modeLabel",minWidth:140,widthGrow:1,headerSort:!1,headerClick:(t,n)=>C("mode",n.getElement())},{title:"Hours bracket",field:"hoursCommitmentLabel",minWidth:120,widthGrow:1},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",minWidth:90,widthGrow:.8},{title:v("Areas","area"),field:"areas",formatter:ge,sorter:Se,minWidth:300,widthGrow:3,headerSort:!1,headerClick:(t,n)=>C("area",n.getElement())},{title:"Focus",field:"focusContext",formatter:"textarea",minWidth:210,widthGrow:1.6},{title:"Timezone",field:"timezone",minWidth:90,widthGrow:.8},{title:"Created",field:"createdAtTs",sorter:"number",formatter:ye,minWidth:145,widthGrow:1},{title:v("Cohort","cohort"),field:"cohort",minWidth:90,widthGrow:.8,headerSort:!1,headerClick:(t,n)=>C("cohort",n.getElement())}]}),l.on("tableBuilt",()=>{p=!0,P(),L?(L=!1,x()):S()}),l.on("renderComplete",()=>P()),l.on("dataFiltered",()=>S()),l.on("dataLoaded",()=>S());return}p=!0,l.replaceData(e)}function ge(e){const t=e.getValue(),n=Array.isArray(t)?t:[];return n.length?`<ul class="cell-list">${n.map(o=>{const i=w(o);return`<li title="${i}">${i}</li>`}).join("")}</ul>`:""}function v(e,t){const n=w(e),r=w(t);return`<span class="th-filter-label">${n}</span><span class="th-filter-trigger" data-filter-key="${r}">Filter ▾</span>`}function Se(e,t){const n=V(e),r=V(t);return n.localeCompare(r)}function V(e){return Array.isArray(e)?e.map(t=>String(t||"")).join(" | ").toLowerCase():e==null?"":String(e).toLowerCase()}function ye(e){return k(Number(e.getValue()||0))}function be(e){return e.map((t,n)=>{const r=Ee(t),o=Fe(t.createdAt),i=t.hoursCommitmentLabel||t.hoursCommitmentKey||t.hoursCommitment||t["hours-commitment"]||"",a=_(t.hoursEstimate,ke(i)),c=t.modeLabel||t.modeKey||t.mode||"",d=t.focusContext||t["focus-context"]||"";return{id:String(t.donationId||"")||`row-${n}-${o}`,donationId:String(t.donationId||""),email:String(t.email||""),name:String(t.name||t.profile&&t.profile.name||""),batch:String(t.batch||t.profile&&t.profile.batch||""),department:String(t.department||t.profile&&t.profile.department||""),timezone:String(t.timezone||""),modeLabel:String(c),modeKey:String(t.modeKey||""),hoursCommitmentLabel:String(i),hoursCommitmentKey:String(t.hoursCommitmentKey||""),hoursEstimate:a,areas:r,focusContext:String(d),createdAt:t.createdAt,createdAtTs:o,createdAtDisplay:k(o),cohort:String(t.cohort||"")}})}function Ee(e){if(Array.isArray(e.areas)&&e.areas.length)return e.areas.map(n=>String(n||"").trim()).filter(Boolean);if(Array.isArray(e.area)&&e.area.length)return e.area.map(n=>String(n||"").trim()).filter(Boolean);const t=String(e.area||"").trim();if(!t)return[];if(t[0]==="[")try{const n=JSON.parse(t);if(Array.isArray(n))return n.map(r=>String(r||"").trim()).filter(Boolean)}catch{}return t.split(",").map(n=>n.trim()).filter(Boolean)}function Le(e){T("mode",Y,J,D(e,t=>[t.modeLabel]).filter(Boolean)),T("area",Z,Q,D(e,t=>t.areas||[]).filter(Boolean)),T("cohort",te,ee,D(e,t=>[t.cohort]).filter(Boolean))}function D(e,t){const n={};return e.forEach(r=>{(t(r)||[]).forEach(i=>{const a=String(i||"").trim();a&&(n[a]=!0)})}),Object.keys(n).sort((r,o)=>r.localeCompare(o))}function T(e,t,n,r){if(!t)return;const o=s[e]||new Set,i=new Set;r.forEach(a=>{o.has(a)&&i.add(a)}),s[e]=i,t.innerHTML="",r.forEach(a=>{const c=document.createElement("label");c.className="area-filter-option";const d=document.createElement("input");d.type="checkbox",d.value=a,d.checked=s[e].has(a),d.addEventListener("change",()=>{d.checked?s[e].add(a):s[e].delete(a),n&&(n.checked=s[e].size===0),A(e),x()});const I=document.createElement("span");I.textContent=a,c.appendChild(d),c.appendChild(I),t.appendChild(c)}),n&&(n.checked=s[e].size===0),A(e)}function A(e){const t=s[e]?s[e].size:0;(B?B.querySelectorAll(`.th-filter-trigger[data-filter-key="${e}"]`):[]).forEach(r=>{r.textContent=t>0?`Filter (${t}) ▾`:"Filter ▾",r.classList.toggle("is-active",t>0)})}function P(){f.forEach(e=>A(e.key))}function x(){if(l){if(!p){L=!0;return}l.setFilter(e=>!(s.mode.size>0&&!s.mode.has(String(e.modeLabel||""))||s.cohort.size>0&&!s.cohort.has(String(e.cohort||""))||s.area.size>0&&!(Array.isArray(e.areas)?e.areas:[]).some(r=>s.area.has(String(r||""))))),S()}}function S(){const e=O(),t=e.reduce((n,r)=>n+_(r.hoursEstimate,0),0);if(X&&(X.textContent=String(e.length)),K&&(K.textContent=re(t)),Ae(e),R&&(R.value=""),G){const n=$ instanceof Date?$:new Date;G.textContent=`${e.length} visible rows of ${m.length} total | Drive: ${N||"n/a"} | Updated: ${k(n.getTime())}`}}function O(){return l?l.getData("active")||[]:[]}function Ae(e){if(!y)return;const t={};e.forEach(r=>{(Array.isArray(r.areas)&&r.areas.length?r.areas:["Unspecified"]).forEach(i=>{t[i]||(t[i]={rows:0}),t[i].rows+=1})});const n=Object.keys(t).sort((r,o)=>t[o].rows-t[r].rows);if(y.innerHTML="",n.forEach(r=>{const o=document.createElement("tr");o.innerHTML=`<td>${w(r)}</td><td>${t[r].rows}</td>`,y.appendChild(o)}),n.length===0){const r=document.createElement("tr");r.innerHTML='<td colspan="2">No rows in current view.</td>',y.appendChild(r)}}function we(e){const t=new Date,n=e.reduce((a,c)=>a+_(c.hoursEstimate,0),0),r={};e.forEach(a=>{(Array.isArray(a.areas)&&a.areas.length?a.areas:["Unspecified"]).forEach(d=>{r[d]=(r[d]||0)+1})});const o=[];o.push(`Weekly supply update (${Ce(t.getTime())})`),o.push(`Drive: ${N||"n/a"}`),o.push(`Visible donations: ${e.length}`),o.push(`Total estimated hours: ${re(n)}`),o.push(""),o.push("Breakdown by area (donation count):");const i=Object.keys(r).sort((a,c)=>r[c]-r[a]);return i.length?i.forEach(a=>{o.push(`- ${a}: ${r[a]} donations`)}):o.push("- No area data in current view."),o.push(""),o.push(`Generated at: ${k(t.getTime())}`),o.join(`
`)}function xe(){const e=O();if(!e.length){u("No rows in current view to export.");return}ne(`timebank-current-view-${ie(new Date)}.xlsx`,e)}function _e(){if(!m.length){u("No data to export.");return}ne(`timebank-full-data-${ie(new Date)}.xlsx`,m)}function ne(e,t){if(!window.XLSX){u("XLSX export library failed to load.");return}const n=t.map(i=>({donation_id:i.donationId,email:i.email,name:i.name,batch:i.batch,department:i.department,mode:i.modeLabel,hours_bracket:i.hoursCommitmentLabel,hours_estimate:i.hoursEstimate,areas:i.areas.join(" | "),focus:i.focusContext,outreach_status:"",timezone:i.timezone,created_at:i.createdAtDisplay,cohort:i.cohort})),r=XLSX.utils.book_new(),o=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(r,o,"donations"),XLSX.writeFile(r,e),u(`Exported ${n.length} rows to ${e}`)}function ke(e){const t=String(e||"").toLowerCase();if(t.indexOf("2-12")!==-1)return 7;if(t.indexOf("24")!==-1)return 24;if(t.indexOf("48")!==-1)return 48;const n=t.match(/(\d+)/);if(!n)return 0;const r=Number(n[1]);return Number.isFinite(r)?r:0}function _(e,t){const n=Number(e);return Number.isFinite(n)?n:Number(t)||0}function Fe(e){if(e==null||e==="")return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}function re(e){return _(e,0).toLocaleString(void 0,{maximumFractionDigits:1})}function Ce(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function k(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function ie(e){return e.toISOString().slice(0,10)}function w(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function u(e){F&&(F.textContent=e,F.classList.toggle("hidden",!e))}
