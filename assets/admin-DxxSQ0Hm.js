import{G as te,S as ne,B as re}from"./runtime-DPWUjJdk.js";let h=null,l=null,m=[],v="",w=null,s={mode:new Set,area:new Set,cohort:new Set};const g=document.getElementById("admin-login"),S=document.getElementById("admin-table"),$=document.querySelector("[data-summary]"),B=document.querySelector("[data-refresh]"),N=document.querySelector("[data-export-current]"),I=document.querySelector("[data-export-all]"),C=document.querySelector("[data-signout]"),E=document.querySelector("[data-status]"),oe=document.getElementById("admin-grid"),R=document.querySelector("[data-visible-rows]"),z=document.querySelector("[data-visible-hours]"),p=document.querySelector("[data-category-body]"),x=document.querySelector("[data-report-output]"),G=document.querySelector("[data-generate-report]"),H=document.querySelector("[data-mode-filter-toggle]"),ae=document.querySelector("[data-mode-filter-menu]"),M=document.querySelector("[data-mode-filter-all]"),X=document.querySelector("[data-mode-filter-options]"),K=document.querySelector("[data-area-filter-toggle]"),ie=document.querySelector("[data-area-filter-menu]"),j=document.querySelector("[data-area-filter-all]"),U=document.querySelector("[data-area-filter-options]"),V=document.querySelector("[data-cohort-filter-toggle]"),se=document.querySelector("[data-cohort-filter-menu]"),J=document.querySelector("[data-cohort-filter-all]"),P=document.querySelector("[data-cohort-filter-options]"),_=[{key:"mode",toggle:H,menu:ae,all:M,options:X,allLabel:"All modes"},{key:"area",toggle:K,menu:ie,all:j,options:U,allLabel:"All areas"},{key:"cohort",toggle:V,menu:se,all:J,options:P,allLabel:"All cohorts"}];window.handleCredentialResponse=e=>{h=e.credential,sessionStorage.setItem("timebank_admin_token",h),u("Signing you in..."),T()};f();le();const W=sessionStorage.getItem("timebank_admin_token");W&&(h=W,T());B&&B.addEventListener("click",()=>T());N&&N.addEventListener("click",()=>Se());I&&I.addEventListener("click",()=>ye());C&&C.addEventListener("click",()=>{sessionStorage.removeItem("timebank_admin_token"),h=null,m=[],s={mode:new Set,area:new Set,cohort:new Set},l&&(l.destroy(),l=null),S.classList.add("hidden"),g.classList.remove("hidden"),u("Signed out")});G&&G.addEventListener("click",()=>{const e=F();x.value=ge(e)});function le(){_.forEach(e=>{e.toggle&&e.menu&&e.toggle.addEventListener("click",t=>{t.stopPropagation(),ce(e.key),e.menu.classList.toggle("hidden")}),e.all&&e.all.addEventListener("change",()=>{if(!e.all.checked)return;s[e.key]=new Set,(e.options?e.options.querySelectorAll('input[type="checkbox"]'):[]).forEach(n=>{n.checked=!1}),k(e.key),D()})}),document.addEventListener("click",e=>{_.forEach(t=>{!t.menu||t.menu.classList.contains("hidden")||t.menu.contains(e.target)||t.toggle&&t.toggle.contains(e.target)||t.menu.classList.add("hidden")})})}function ce(e){_.forEach(t=>{t.key!==e&&t.menu&&t.menu.classList.add("hidden")})}function f(){if(window.google&&google.accounts&&google.accounts.id){google.accounts.id.initialize({client_id:te,callback:handleCredentialResponse,auto_select:!1,use_fedcm_for_prompt:!0});const e=document.querySelector("[data-gsi-admin]");e&&google.accounts.id.renderButton(e,{type:"standard",size:"large",width:280,theme:"outline",text:"continue_with",shape:"pill",logo_alignment:"left"});return}f.attempts>30||(f.attempts+=1,setTimeout(f,250))}f.attempts=0;async function T(){if(!h){g.classList.remove("hidden"),S.classList.add("hidden");return}u("Loading data...");try{const n=await(await fetch(re,{method:"POST",body:JSON.stringify({action:"admin_list_joined_donations",sharedKey:ne,credential:h}),headers:{"Content-Type":"text/plain;charset=utf-8"}})).text(),r=JSON.parse(n);if(!r.success)throw new Error(r.error||"Unknown error");v=r.drive&&r.drive.label?String(r.drive.label):"",w=r.generatedAt?new Date(r.generatedAt):new Date,m=me(r.rows||[]),de(m),fe(m),D(),y(),g.classList.add("hidden"),S.classList.remove("hidden"),u("")}catch(e){console.error(e),u(e.message||"Failed to load"),/Access denied/i.test(e.message||"")&&(g.classList.remove("hidden"),S.classList.add("hidden"))}}function de(e){if(!window.Tabulator)throw new Error("Tabulator failed to load");if(!l){l=new Tabulator(oe,{data:e,layout:"fitColumns",height:"62vh",index:"id",movableColumns:!0,pagination:!0,paginationSize:30,placeholder:"No donations available for the selected filters.",initialSort:[{column:"createdAtTs",dir:"desc"}],columns:[{title:"Email",field:"email",minWidth:210,widthGrow:2},{title:"Name",field:"name",minWidth:140,widthGrow:1.4},{title:"Batch",field:"batch",minWidth:70,widthGrow:.7,hozAlign:"center"},{title:"Department",field:"department",minWidth:130,widthGrow:1.3},{title:"Mode",field:"modeLabel",minWidth:140,widthGrow:1},{title:"Hours bracket",field:"hoursCommitmentLabel",minWidth:120,widthGrow:1},{title:"Hours (est)",field:"hoursEstimate",sorter:"number",hozAlign:"right",bottomCalc:"sum",minWidth:90,widthGrow:.8},{title:"Areas",field:"areas",formatter:ue,minWidth:300,widthGrow:3},{title:"Focus",field:"focusContext",formatter:"textarea",minWidth:210,widthGrow:1.6},{title:"Timezone",field:"timezone",minWidth:90,widthGrow:.8},{title:"Created",field:"createdAtDisplay",sorter:"datetime",minWidth:145,widthGrow:1},{title:"Cohort",field:"cohort",minWidth:90,widthGrow:.8}]}),l.on("dataFiltered",()=>y()),l.on("dataLoaded",()=>y());return}l.replaceData(e)}function ue(e){const t=e.getValue(),n=Array.isArray(t)?t:[];return n.length?`<ul class="cell-list">${n.map(a=>{const o=ee(a);return`<li title="${o}">${o}</li>`}).join("")}</ul>`:""}function me(e){return e.map((t,n)=>{const r=he(t),a=Ee(t.createdAt),o=t.hoursCommitmentLabel||t.hoursCommitmentKey||t.hoursCommitment||t["hours-commitment"]||"",i=b(t.hoursEstimate,be(o)),c=t.modeLabel||t.modeKey||t.mode||"",d=t.focusContext||t["focus-context"]||"";return{id:String(t.donationId||"")||`row-${n}-${a}`,donationId:String(t.donationId||""),email:String(t.email||""),name:String(t.name||t.profile&&t.profile.name||""),batch:String(t.batch||t.profile&&t.profile.batch||""),department:String(t.department||t.profile&&t.profile.department||""),timezone:String(t.timezone||""),modeLabel:String(c),modeKey:String(t.modeKey||""),hoursCommitmentLabel:String(o),hoursCommitmentKey:String(t.hoursCommitmentKey||""),hoursEstimate:i,areas:r,focusContext:String(d),createdAt:t.createdAt,createdAtTs:a,createdAtDisplay:q(a),cohort:String(t.cohort||"")}})}function he(e){if(Array.isArray(e.areas)&&e.areas.length)return e.areas.map(n=>String(n||"").trim()).filter(Boolean);if(Array.isArray(e.area)&&e.area.length)return e.area.map(n=>String(n||"").trim()).filter(Boolean);const t=String(e.area||"").trim();if(!t)return[];if(t[0]==="[")try{const n=JSON.parse(t);if(Array.isArray(n))return n.map(r=>String(r||"").trim()).filter(Boolean)}catch{}return t.split(",").map(n=>n.trim()).filter(Boolean)}function fe(e){A("mode",X,M,L(e,t=>[t.modeLabel]).filter(Boolean)),A("area",U,j,L(e,t=>t.areas||[]).filter(Boolean)),A("cohort",P,J,L(e,t=>[t.cohort]).filter(Boolean))}function L(e,t){const n={};return e.forEach(r=>{(t(r)||[]).forEach(o=>{const i=String(o||"").trim();i&&(n[i]=!0)})}),Object.keys(n).sort((r,a)=>r.localeCompare(a))}function A(e,t,n,r){if(!t)return;const a=s[e]||new Set,o=new Set;r.forEach(i=>{a.has(i)&&o.add(i)}),s[e]=o,t.innerHTML="",r.forEach(i=>{const c=document.createElement("label");c.className="area-filter-option";const d=document.createElement("input");d.type="checkbox",d.value=i,d.checked=s[e].has(i),d.addEventListener("change",()=>{d.checked?s[e].add(i):s[e].delete(i),n&&(n.checked=s[e].size===0),k(e),D()});const O=document.createElement("span");O.textContent=i,c.appendChild(d),c.appendChild(O),t.appendChild(c)}),n&&(n.checked=s[e].size===0),k(e)}function k(e){let t=null,n="";if(e==="mode"?(t=H,n="Mode"):e==="area"?(t=K,n="Areas"):e==="cohort"&&(t=V,n="Cohort"),!t)return;const r=s[e]?s[e].size:0;t.textContent=r>0?`${n} (${r})`:n}function D(){l&&(l.setFilter(e=>!(s.mode.size>0&&!s.mode.has(String(e.modeLabel||""))||s.cohort.size>0&&!s.cohort.has(String(e.cohort||""))||s.area.size>0&&!(Array.isArray(e.areas)?e.areas:[]).some(r=>s.area.has(String(r||""))))),y())}function y(){const e=F(),t=e.reduce((n,r)=>n+b(r.hoursEstimate,0),0);if(R&&(R.textContent=String(e.length)),z&&(z.textContent=Q(t)),pe(e),x&&(x.value=""),$){const n=w instanceof Date?w:new Date;$.textContent=`${e.length} visible rows of ${m.length} total | Drive: ${v||"n/a"} | Updated: ${q(n.getTime())}`}}function F(){return l?l.getData("active")||[]:[]}function pe(e){if(!p)return;const t={};e.forEach(r=>{(Array.isArray(r.areas)&&r.areas.length?r.areas:["Unspecified"]).forEach(o=>{t[o]||(t[o]={rows:0}),t[o].rows+=1})});const n=Object.keys(t).sort((r,a)=>t[a].rows-t[r].rows);if(p.innerHTML="",n.forEach(r=>{const a=document.createElement("tr");a.innerHTML=`<td>${ee(r)}</td><td>${t[r].rows}</td>`,p.appendChild(a)}),n.length===0){const r=document.createElement("tr");r.innerHTML='<td colspan="2">No rows in current view.</td>',p.appendChild(r)}}function ge(e){const t=new Date,n=e.reduce((i,c)=>i+b(c.hoursEstimate,0),0),r={};e.forEach(i=>{(Array.isArray(i.areas)&&i.areas.length?i.areas:["Unspecified"]).forEach(d=>{r[d]=(r[d]||0)+1})});const a=[];a.push(`Weekly supply update (${Le(t.getTime())})`),a.push(`Drive: ${v||"n/a"}`),a.push(`Visible donations: ${e.length}`),a.push(`Total estimated hours: ${Q(n)}`),a.push(""),a.push("Breakdown by area (donation count):");const o=Object.keys(r).sort((i,c)=>r[c]-r[i]);return o.length?o.forEach(i=>{a.push(`- ${i}: ${r[i]} donations`)}):a.push("- No area data in current view."),a.push(""),a.push(`Generated at: ${q(t.getTime())}`),a.join(`
`)}function Se(){const e=F();if(!e.length){u("No rows in current view to export.");return}Y(`timebank-current-view-${Z(new Date)}.xlsx`,e)}function ye(){if(!m.length){u("No data to export.");return}Y(`timebank-full-data-${Z(new Date)}.xlsx`,m)}function Y(e,t){if(!window.XLSX){u("XLSX export library failed to load.");return}const n=t.map(o=>({donation_id:o.donationId,email:o.email,name:o.name,batch:o.batch,department:o.department,mode:o.modeLabel,hours_bracket:o.hoursCommitmentLabel,hours_estimate:o.hoursEstimate,areas:o.areas.join(" | "),focus:o.focusContext,outreach_status:"",timezone:o.timezone,created_at:o.createdAtDisplay,cohort:o.cohort})),r=XLSX.utils.book_new(),a=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(r,a,"donations"),XLSX.writeFile(r,e),u(`Exported ${n.length} rows to ${e}`)}function be(e){const t=String(e||"").toLowerCase();if(t.indexOf("2-12")!==-1)return 7;if(t.indexOf("24")!==-1)return 24;if(t.indexOf("48")!==-1)return 48;const n=t.match(/(\d+)/);if(!n)return 0;const r=Number(n[1]);return Number.isFinite(r)?r:0}function b(e,t){const n=Number(e);return Number.isFinite(n)?n:Number(t)||0}function Ee(e){if(e==null||e==="")return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}function Q(e){return b(e,0).toLocaleString(void 0,{maximumFractionDigits:1})}function Le(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().slice(0,10):""}function q(e){if(!e)return"";const t=new Date(e);return Number.isFinite(t.getTime())?t.toISOString().replace("T"," ").slice(0,16)+" UTC":""}function Z(e){return e.toISOString().slice(0,10)}function ee(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t]||t)}function u(e){E&&(E.textContent=e,E.classList.toggle("hidden",!e))}
